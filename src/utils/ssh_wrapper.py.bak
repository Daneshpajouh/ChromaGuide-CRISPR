import pty
import sys
import os
import time
import subprocess

# SSH Command to establish ControlMaster (Persistent Socket)
# -tt: Force TTY (Redundant if pty.spawn used, but good practice)
# -N: Do not execute a remote command (Forwarding only)
# -f: Fork into background? No, pty needs to hold it?
# If we -f, pty might lose control.
# We want to keep it running for at least enough time to auth.
# Once Auth is done, if ControlMaster is auto, the socket exists.
# Then we can exit the python script?
# No, if the Master process dies, the socket dies.
# So we need this script to stay alive?
# If we use `ssh -M -fN`, it forks to background.
# But `ssh` refuses to fork if it needs password and no TTY.
# With `pty`, it thinks it has TTY.
# So `ssh -o ControlPersist=72h fir` might be enough?
# Let's try to run `ssh fir exit`.
# If Auth succeeds, it creates the socket (ControlMaster auto + Persist).
# Then it exits. The socket stays ALIVE for 72h (daemonized by ssh mux).
# This is the beauty of ControlPersist.
# So we just need to pass the Auth hurdle once.

def run_ssh_auth():
    print("Spawning SSH to trigger MFA...")
    # Using 'exit' command ensures it terminates after auth
    cmd = ['ssh', 'fir', 'exit']

    # Fork a child process
    pid, fd = pty.fork()

    if pid == 0:
        # Child: Replace with SSH
        os.execvp(cmd[0], cmd)
    else:
        # Parent: Read output and print to stdout so Agent can see
        try:
            while True:
                # Read 1024 bytes
                try:
                     output = os.read(fd, 1024).decode()
                except OSError:
                    break # Child exited

                if not output:
                    break

                print(output, end='')

                # If we see "keyboard-interactive", we might need to send "1\n" or just wait.
                # Usually default is Push if configured.
                # If we see "Permission denied", we failed.

                sys.stdout.flush()
        except Exception as e:
            pass

        # Wait for child
        os.waitpid(pid, 0)
        print("\nSSH Process Finished.")

if __name__ == "__main__":
    run_ssh_auth()
