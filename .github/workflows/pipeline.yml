name: Automated Pipeline Execution on Schedule

on:
  schedule:
    # Check Phase 1 every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  orchestrate-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 1440  # 24 hours max
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Phase 1 Status
        env:
          NARVAL_USER: ${{ secrets.NARVAL_USER }}
          NARVAL_KEY: ${{ secrets.NARVAL_SSH_KEY }}
        run: |
          # Configure SSH
          mkdir -p ~/.ssh
          echo "$NARVAL_KEY" > ~/.ssh/narval_key
          chmod 600 ~/.ssh/narval_key
          
          # Check job status
          ssh -i ~/.ssh/narval_key -o StrictHostKeyChecking=no \
              $NARVAL_USER@narval.alliancecan.ca \
              'squeue -j 56644478 --format=%T | tail -1'
      
      - name: Download Phase 1 Results
        if: success()
        run: |
          python orchestrate_pipeline.py \
            --watch-job 56644478 \
            --auto-push-github
      
      - name: Commit Results
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add -A
          git commit -m "feat: automated pipeline execution $(date)" || true
          git push

  tests:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: pytest tests/ -v --cov
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install linters
        run: |
          pip install pylint flake8 black
      
      - name: Run linters
        run: |
          black --check src/ scripts/ 2>/dev/null || true
          flake8 src/ scripts/ --max-line-length=100 || true
